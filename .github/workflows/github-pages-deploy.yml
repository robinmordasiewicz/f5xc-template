name: Build and Deploy Docs
on:
  workflow_dispatch:
  workflow_call:
    inputs:
      content-path:
        description: 'Path to content directory in the calling repo'
        required: false
        default: 'docs'
        type: string
      builder-image:
        description: 'Builder Docker image URI'
        required: false
        default: 'ghcr.io/robinmordasiewicz/f5xc-docs-builder:latest'
        type: string
      docs-title:
        description: 'Documentation site title (overrides frontmatter)'
        required: false
        type: string
      docs-site:
        description: 'Documentation site URL'
        required: false
        default: 'https://robinmordasiewicz.github.io'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      packages: read
    outputs:
      build-status: ${{ job.status }}
    steps:
      - name: Checkout content repo
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build docs with container
        run: |
          mkdir -p ${{ runner.temp }}/docs-output

          docker run --rm \
            --name docs-builder \
            -v ${{ github.workspace }}/${{ inputs.content-path || 'docs' }}:/content/docs:ro \
            -v ${{ runner.temp }}/docs-output:/output \
            -e CONTENT_DIR=/content/docs \
            -e OUTPUT_DIR=/output \
            -e DOCS_SITE="${{ inputs.docs-site || 'https://robinmordasiewicz.github.io' }}" \
            -e GITHUB_REPOSITORY="${{ github.repository }}" \
            ${{ inputs.docs-title && format('-e DOCS_TITLE="{0}"', inputs.docs-title) || '' }} \
            ${{ inputs.builder-image || 'ghcr.io/robinmordasiewicz/f5xc-docs-builder:latest' }}

          echo "✅ Build completed successfully"
          ls -lah ${{ runner.temp }}/docs-output/

      - name: Verify build output
        run: |
          OUTPUT_DIR="${{ runner.temp }}/docs-output"

          if [ ! -d "$OUTPUT_DIR" ] || [ -z "$(ls -A $OUTPUT_DIR)" ]; then
            echo "❌ Build output is empty"
            exit 1
          fi

          echo "✅ Build output verified"
          echo "Files generated:"
          find "$OUTPUT_DIR" -type f | head -20

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ runner.temp }}/docs-output
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: success()
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
